{% extends 'base.html' %}

{% block content %}
    <h1>Safetea.</h1>

    {% for post in posts %}
        <div class="card">
            <span class="card-content"><h3>{{ post.name }}</h3></span>
            {% if post.image %}
            <img src="{{ post.image.url }}" alt="{{ post.name }}">
        {% endif %}
            <p>City: {{ post.city }}</p>
            <p>Description: {{ post.description }}</p>
            <p>Age: {{ post.age }}</p>

            {% for comment in post.comments.all %}
                <div class="comment">
                    <p>{{ comment.user.username }} says:</p>
                    <p>{{ comment.text }}</p>
                </div>
            {% empty %}
                <p>No comments yet.</p>
            {% endfor %}

            <form method="POST" action="{% url 'add_comment' post.id %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="comment-text">Add a comment:</label>
                    <textarea class="form-control" id="comment-text" name="comment-text" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>

            <form method="POST" action="{% url 'delete_post' post.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
        </div>

        <script>
            // Handle the comment form submission
            $('#comment-form').on('submit', function(event) {
              event.preventDefault(); // Prevent the form from submitting normally
              var form = $(this); // Get the form element
              $.ajax({
                url: form.attr('action'),
                method: 'POST',
                data: form.serialize(),
                dataType: 'json',
                success: function(response) {
                  if (response.success) {
                    // If the comment was added successfully, append the new comment to the comments container
                    $('#comments-container').append(response.comment_html);
                    form.trigger('reset'); // Reset the comment form
                  } else {
                    // If there was an error, display the form errors
                    alert('There was an error adding your comment: ' + response.errors);
                  }
                },
                error: function() {
                  alert('There was an error adding your comment. Please try again later.');
                }
              });
            });
            </script>
        
    {% endfor %}
{% endblock %}

